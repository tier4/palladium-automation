name: Cleanup Old Task Results

on:
  schedule:
    # 毎日 00:00 UTC (JST 09:00) に実行
    - cron: '0 0 * * *'
  workflow_dispatch:  # 手動実行も可能

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Remove old task directories
        id: cleanup
        run: |
          cd results/ || exit 0

          # 現在時刻（Unix timestamp）
          NOW=$(date +%s)
          RETENTION_DAYS=3
          RETENTION_SECONDS=$((RETENTION_DAYS * 86400))

          DELETED=0
          TOTAL=0

          echo "Scanning for task directories older than ${RETENTION_DAYS} days..."

          for dir in */; do
            if [ -d "$dir" ]; then
              TOTAL=$((TOTAL + 1))

              # ディレクトリの最終更新時刻を取得
              MTIME=$(stat -c %Y "$dir" 2>/dev/null || stat -f %m "$dir" 2>/dev/null || echo 0)

              if [ "$MTIME" -eq 0 ]; then
                echo "WARNING: Cannot get mtime for $dir, skipping"
                continue
              fi

              AGE=$((NOW - MTIME))
              AGE_DAYS=$((AGE / 86400))

              if [ $AGE -gt $RETENTION_SECONDS ]; then
                echo "Removing old directory: $dir (age: ${AGE_DAYS} days)"
                rm -rf "$dir"
                DELETED=$((DELETED + 1))
              else
                echo "Keeping directory: $dir (age: ${AGE_DAYS} days)"
              fi
            fi
          done

          echo ""
          echo "=== Cleanup Summary ==="
          echo "Total directories scanned: $TOTAL"
          echo "Directories deleted: $DELETED"
          echo "Directories retained: $((TOTAL - DELETED))"

          echo "deleted_count=$DELETED" >> $GITHUB_OUTPUT
          echo "total_count=$TOTAL" >> $GITHUB_OUTPUT

      - name: Commit and push if changes exist
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -n "$(git status --porcelain)" ]; then
            git add results/
            git commit -m "chore: cleanup task results older than 3 days (deleted: ${{ steps.cleanup.outputs.deleted_count }} of ${{ steps.cleanup.outputs.total_count }})"
            git push
            echo "✅ Changes committed and pushed"
          else
            echo "ℹ️ No changes to commit (no old task directories found)"
          fi

      - name: Summary
        run: |
          echo "### Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Total directories: ${{ steps.cleanup.outputs.total_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deleted: ${{ steps.cleanup.outputs.deleted_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- Retained: $((${{ steps.cleanup.outputs.total_count }} - ${{ steps.cleanup.outputs.deleted_count }}))" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Retention policy: **3 days**" >> $GITHUB_STEP_SUMMARY
